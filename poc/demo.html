<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catering App - POC Demo</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 30px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: #f39c12;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-tier {
            background: linear-gradient(135deg, #f39c12, #e74c3c);
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        /* Main Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 1fr 350px;
            gap: 30px;
        }

        /* Menu Section */
        .menu-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }

        .menu-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 15px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .menu-item:hover {
            transform: translateY(-5px);
            border-color: #f39c12;
            background: rgba(255, 255, 255, 0.12);
        }

        .menu-item.selected {
            border-color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }

        .menu-item h3 {
            font-size: 16px;
            margin-bottom: 8px;
        }

        .menu-item .price {
            font-size: 20px;
            font-weight: 700;
            color: #f39c12;
        }

        .menu-item .serves {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 5px;
        }

        /* Cart Section */
        .cart-section {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            position: sticky;
            top: 20px;
        }

        .cart-items {
            margin: 20px 0;
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .cart-total {
            display: flex;
            justify-content: space-between;
            padding: 20px 0;
            font-size: 24px;
            font-weight: 700;
        }

        .cart-total .amount {
            color: #2ecc71;
        }

        /* Event Type Selector */
        .event-selector {
            margin: 20px 0;
        }

        .event-selector label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.7);
        }

        .event-selector select {
            width: 100%;
            padding: 12px;
            border-radius: 10px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 14px;
        }

        /* Guest Count */
        .guest-count {
            margin: 20px 0;
        }

        .guest-count label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: rgba(255, 255, 255, 0.7);
        }

        .guest-input {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .guest-input button {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            background: #f39c12;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
        }

        .guest-input span {
            font-size: 24px;
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }

        /* Help Button */
        .help-button {
            width: 100%;
            padding: 18px;
            border-radius: 15px;
            border: none;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: #fff;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .help-button:hover {
            transform: scale(1.02);
            box-shadow: 0 10px 30px rgba(52, 152, 219, 0.3);
        }

        .help-button:disabled {
            background: #555;
            cursor: not-allowed;
            transform: none;
        }

        .help-button.hidden {
            display: none;
        }

        /* Behavior Simulator */
        .behavior-panel {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
        }

        .behavior-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-top: 20px;
        }

        .behavior-item {
            background: rgba(255, 255, 255, 0.08);
            padding: 15px;
            border-radius: 10px;
        }

        .behavior-item label {
            display: block;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 5px;
        }

        .behavior-item input {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: none;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            font-size: 16px;
        }

        .behavior-item .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 14px;
            color: #fff;
            cursor: pointer;
        }

        .behavior-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
        }

        /* Results Panel */
        .results-panel {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            border-radius: 20px;
            padding: 25px;
            margin-top: 30px;
            display: none;
        }

        .results-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-section {
            margin-bottom: 25px;
            padding-bottom: 25px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .result-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .result-title {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .result-value {
            font-size: 24px;
            font-weight: 700;
        }

        .result-value.success {
            color: #2ecc71;
        }

        .result-value.warning {
            color: #f39c12;
        }

        .result-value.danger {
            color: #e74c3c;
        }

        .channels-list {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .channel-badge {
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
        }

        .channel-badge.chat {
            background: #3498db;
        }

        .channel-badge.call {
            background: #9b59b6;
        }

        .channel-badge.none {
            background: #7f8c8d;
        }

        /* Friction Score Bar */
        .friction-bar {
            width: 100%;
            height: 12px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            margin-top: 15px;
            overflow: hidden;
        }

        .friction-fill {
            height: 100%;
            border-radius: 6px;
            transition: width 0.5s ease;
        }

        .friction-fill.low {
            background: #2ecc71;
        }

        .friction-fill.medium {
            background: #f39c12;
        }

        .friction-fill.high {
            background: #e74c3c;
        }

        .breakdown-list {
            margin-top: 15px;
        }

        .breakdown-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
        }

        .breakdown-item span:last-child {
            font-weight: 600;
            color: #f39c12;
        }

        /* Current Screen Indicator */
        .screen-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 12px;
            z-index: 100;
        }

        .screen-indicator span {
            color: #f39c12;
            font-weight: 600;
        }

        /* Simulate Actions */
        .simulate-btn {
            padding: 12px 24px;
            border-radius: 10px;
            border: 2px solid #f39c12;
            background: transparent;
            color: #f39c12;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-top: 10px;
        }

        .simulate-btn:hover {
            background: #f39c12;
            color: #1a1a2e;
        }

        /* Agent View Modal */
        .agent-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .agent-modal.active {
            display: flex;
        }

        .agent-view {
            background: #fff;
            color: #333;
            width: 500px;
            border-radius: 20px;
            overflow: hidden;
        }

        .agent-header {
            background: #2c3e50;
            color: #fff;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .agent-header h3 {
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            color: #fff;
            font-size: 24px;
            cursor: pointer;
        }

        .agent-content {
            padding: 25px;
        }

        .context-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }

        .context-item:last-child {
            border-bottom: none;
        }

        .context-label {
            color: #666;
            font-size: 14px;
        }

        .context-value {
            font-weight: 600;
            color: #2c3e50;
        }

        .context-value.highlight {
            color: #e74c3c;
        }
    </style>
</head>

<body>
    <div class="screen-indicator">
        Current Screen: <span id="currentScreen">Menu</span>
    </div>

    <div class="container">
        <header class="header">
            <div class="logo">üçΩÔ∏è CaterEase</div>
            <div class="user-info">
                <span>Welcome, Rahul</span>
                <span class="user-tier">üåü First-Time User</span>
            </div>
        </header>

        <div class="main-layout">
            <!-- Menu Section -->
            <div class="menu-section">
                <h2 class="section-title">üìã Select Your Package</h2>
                <div class="menu-grid">
                    <div class="menu-item" onclick="selectPackage(this, 'Basic Package', 8000)">
                        <h3>ü•ó Basic Package</h3>
                        <p class="price">‚Çπ8,000</p>
                        <p class="serves">Serves 50 guests</p>
                    </div>
                    <div class="menu-item" onclick="selectPackage(this, 'Standard Package', 15000)">
                        <h3>üçõ Standard Package</h3>
                        <p class="price">‚Çπ15,000</p>
                        <p class="serves">Serves 100 guests</p>
                    </div>
                    <div class="menu-item" onclick="selectPackage(this, 'Premium Package', 28000)">
                        <h3>üëë Premium Package</h3>
                        <p class="price">‚Çπ28,000</p>
                        <p class="serves">Serves 150 guests</p>
                    </div>
                    <div class="menu-item" onclick="selectPackage(this, 'Royal Wedding', 55000)">
                        <h3>üíí Royal Wedding</h3>
                        <p class="price">‚Çπ55,000</p>
                        <p class="serves">Serves 300 guests</p>
                    </div>
                </div>

                <!-- Behavior Simulator -->
                <div class="behavior-panel">
                    <h2 class="section-title">üéÆ Simulate User Behavior</h2>
                    <p style="color: rgba(255,255,255,0.6); font-size: 14px; margin-bottom: 15px;">
                        Adjust these values to simulate different user behaviors and see how the system responds.
                    </p>
                    <div class="behavior-grid">
                        <div class="behavior-item">
                            <label>Inactivity (seconds)</label>
                            <input type="number" id="inactivitySeconds" value="30" min="0" max="300">
                        </div>
                        <div class="behavior-item">
                            <label>Back Navigations</label>
                            <input type="number" id="backNavCount" value="1" min="0" max="20">
                        </div>
                        <div class="behavior-item">
                            <label>Price Checks</label>
                            <input type="number" id="priceCheckCount" value="2" min="0" max="20">
                        </div>
                        <div class="behavior-item">
                            <label>Payment Retries</label>
                            <input type="number" id="paymentRetryCount" value="0" min="0" max="10">
                        </div>
                    </div>
                    <div style="margin-top: 20px;">
                        <label class="behavior-item checkbox-label">
                            <input type="checkbox" id="isFirstTimeUser" checked>
                            First-time User
                        </label>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="simulate-btn" onclick="simulateFrustration()">üò§ Simulate Frustrated
                            User</button>
                        <button class="simulate-btn" onclick="simulateHappy()">üòä Simulate Happy User</button>
                    </div>
                </div>
            </div>

            <!-- Cart Section -->
            <div class="cart-section">
                <h2 class="section-title">üõí Your Order</h2>

                <div class="event-selector">
                    <label>Event Type</label>
                    <select id="eventType" onchange="updateScreen('Checkout')">
                        <option value="">Select event...</option>
                        <option value="BIRTHDAY">üéÇ Birthday Party</option>
                        <option value="CORPORATE">üè¢ Corporate Event</option>
                        <option value="WEDDING">üíí Wedding</option>
                        <option value="RELIGIOUS">üôè Religious Ceremony</option>
                        <option value="CASUAL">üéâ Casual Gathering</option>
                    </select>
                </div>

                <div class="guest-count">
                    <label>Number of Guests</label>
                    <div class="guest-input">
                        <button onclick="updateGuests(-10)">-</button>
                        <span id="guestCount">100</span>
                        <button onclick="updateGuests(10)">+</button>
                    </div>
                </div>

                <div class="cart-items" id="cartItems">
                    <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 20px;">
                        Select a package to add to cart
                    </p>
                </div>

                <div class="cart-total">
                    <span>Total</span>
                    <span class="amount" id="cartTotal">‚Çπ0</span>
                </div>

                <button class="help-button" id="helpButton" onclick="requestHelp()">
                    üí¨ Need Help?
                </button>

                <!-- Results Panel -->
                <div class="results-panel" id="resultsPanel">
                    <div class="result-section">
                        <div class="result-title">Channel Routing</div>
                        <div class="result-value" id="routingDecision">-</div>
                        <div class="channels-list" id="channelsList"></div>
                        <p style="margin-top: 10px; font-size: 13px; color: rgba(255,255,255,0.6);" id="routingReason">
                        </p>
                    </div>

                    <div class="result-section">
                        <div class="result-title">Friction Score</div>
                        <div class="result-value" id="frictionScore">-</div>
                        <div class="friction-bar">
                            <div class="friction-fill" id="frictionFill" style="width: 0%"></div>
                        </div>
                        <div class="breakdown-list" id="frictionBreakdown"></div>
                    </div>

                    <div class="result-section">
                        <div class="result-title">Suggested Action</div>
                        <div class="result-value" id="helpMessage" style="font-size: 16px;">-</div>
                    </div>

                    <button class="help-button" onclick="showAgentView()"
                        style="background: linear-gradient(135deg, #9b59b6, #8e44ad);">
                        üë§ View Agent Dashboard
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Agent View Modal -->
    <div class="agent-modal" id="agentModal">
        <div class="agent-view">
            <div class="agent-header">
                <h3>üéß Agent Dashboard - Freshchat</h3>
                <button class="close-modal" onclick="closeAgentModal()">&times;</button>
            </div>
            <div class="agent-content">
                <h4 style="margin-bottom: 20px; color: #2c3e50;">Customer Context (Auto-populated)</h4>
                <div class="context-item">
                    <span class="context-label">Customer Name</span>
                    <span class="context-value">Rahul Sharma</span>
                </div>
                <div class="context-item">
                    <span class="context-label">User Type</span>
                    <span class="context-value" id="agentUserType">First-Time User</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Current Screen</span>
                    <span class="context-value" id="agentScreen">Checkout</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Cart Value</span>
                    <span class="context-value" id="agentCartValue">‚Çπ0</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Guest Count</span>
                    <span class="context-value" id="agentGuestCount">100</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Event Type</span>
                    <span class="context-value" id="agentEventType">-</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Selected Package</span>
                    <span class="context-value" id="agentPackage">-</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Friction Score</span>
                    <span class="context-value highlight" id="agentFrictionScore">0</span>
                </div>
                <div class="context-item">
                    <span class="context-label">Priority</span>
                    <span class="context-value" id="agentPriority">-</span>
                </div>
                <p
                    style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 10px; font-size: 13px; color: #666;">
                    üí° <strong>Agent sees all this context instantly</strong> - no need to ask "What are you looking
                    at?" or "What's in your cart?"
                </p>
            </div>
        </div>
    </div>

    <script>
        // State
        let cartValue = 0;
        let selectedPackage = '';
        let guestCount = 100;
        let currentScreen = 'Menu';
        let lastRoutingResult = null;
        let lastFrictionResult = null;

        const API_BASE = 'http://localhost:8000';

        // Select package
        function selectPackage(element, name, price) {
            // Remove previous selection
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('selected');
            });

            // Add selection
            element.classList.add('selected');

            selectedPackage = name;
            cartValue = price;

            // Update cart
            document.getElementById('cartItems').innerHTML = `
                <div class="cart-item">
                    <span>${name}</span>
                    <span>‚Çπ${price.toLocaleString()}</span>
                </div>
            `;
            document.getElementById('cartTotal').textContent = `‚Çπ${price.toLocaleString()}`;

            updateScreen('Checkout');
        }

        // Update guest count
        function updateGuests(delta) {
            guestCount = Math.max(10, guestCount + delta);
            document.getElementById('guestCount').textContent = guestCount;
        }

        // Update current screen
        function updateScreen(screen) {
            currentScreen = screen;
            document.getElementById('currentScreen').textContent = screen;
        }

        // Simulate frustrated user
        function simulateFrustration() {
            document.getElementById('inactivitySeconds').value = 90;
            document.getElementById('backNavCount').value = 6;
            document.getElementById('priceCheckCount').value = 8;
            document.getElementById('paymentRetryCount').value = 2;
        }

        // Simulate happy user
        function simulateHappy() {
            document.getElementById('inactivitySeconds').value = 15;
            document.getElementById('backNavCount').value = 1;
            document.getElementById('priceCheckCount').value = 2;
            document.getElementById('paymentRetryCount').value = 0;
        }

        // Request help - call the APIs
        async function requestHelp() {
            const eventType = document.getElementById('eventType').value;
            const inactivitySeconds = parseInt(document.getElementById('inactivitySeconds').value) || 0;
            const backNavCount = parseInt(document.getElementById('backNavCount').value) || 0;
            const priceCheckCount = parseInt(document.getElementById('priceCheckCount').value) || 0;
            const paymentRetryCount = parseInt(document.getElementById('paymentRetryCount').value) || 0;
            const isFirstTimeUser = document.getElementById('isFirstTimeUser').checked;

            try {
                // Call Channel Router API
                const routingResponse = await fetch(`${API_BASE}/api/v1/channel/route`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_value: cartValue,
                        event_type: eventType || null
                    })
                });
                const routingResult = await routingResponse.json();
                lastRoutingResult = routingResult;

                // Call Friction Detection API
                const frictionResponse = await fetch(`${API_BASE}/api/v1/friction/detect`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'demo_user',
                        inactivity_seconds: inactivitySeconds,
                        back_nav_count: backNavCount,
                        price_check_count: priceCheckCount,
                        payment_retry_count: paymentRetryCount,
                        is_first_time_user: isFirstTimeUser,
                        cart_value: cartValue,
                        event_type: eventType || null,
                        current_screen: currentScreen
                    })
                });
                const frictionResult = await frictionResponse.json();
                lastFrictionResult = frictionResult;

                // Display results
                displayResults(routingResult, frictionResult);

            } catch (error) {
                alert('Error connecting to API. Make sure the server is running on localhost:8000');
                console.error(error);
            }
        }

        // Display results
        function displayResults(routing, friction) {
            const panel = document.getElementById('resultsPanel');
            panel.classList.add('active');

            // Routing result
            const channels = routing.allowed_channels;
            let decisionText, decisionClass;

            if (channels.length === 0) {
                decisionText = 'Self-Serve Only';
                decisionClass = 'warning';
            } else if (channels.includes('CALL')) {
                decisionText = 'Premium Support';
                decisionClass = 'success';
            } else {
                decisionText = 'Chat Support';
                decisionClass = 'success';
            }

            document.getElementById('routingDecision').textContent = decisionText;
            document.getElementById('routingDecision').className = `result-value ${decisionClass}`;
            document.getElementById('routingReason').textContent = routing.reason;

            // Channel badges
            const channelsList = document.getElementById('channelsList');
            if (channels.length === 0) {
                channelsList.innerHTML = '<span class="channel-badge none">No Human Support</span>';
            } else {
                channelsList.innerHTML = channels.map(ch =>
                    `<span class="channel-badge ${ch.toLowerCase()}">${ch}</span>`
                ).join('');
            }

            // Friction score
            const score = friction.friction_score;
            let scoreClass;
            if (score < 40) scoreClass = 'low';
            else if (score < 70) scoreClass = 'medium';
            else scoreClass = 'high';

            document.getElementById('frictionScore').textContent = `${score}/100`;
            document.getElementById('frictionScore').className = `result-value ${score < 40 ? 'success' : score < 70 ? 'warning' : 'danger'}`;

            const fill = document.getElementById('frictionFill');
            fill.style.width = `${score}%`;
            fill.className = `friction-fill ${scoreClass}`;

            // Breakdown
            const breakdown = document.getElementById('frictionBreakdown');
            breakdown.innerHTML = Object.entries(friction.breakdown || {}).map(([key, value]) =>
                `<div class="breakdown-item">
                    <span>${key.replace(/_/g, ' ')}</span>
                    <span>+${value} pts</span>
                </div>`
            ).join('');

            // Help message
            document.getElementById('helpMessage').textContent = friction.help_message || 'No help needed';
        }

        // Show agent view modal
        function showAgentView() {
            const modal = document.getElementById('agentModal');
            modal.classList.add('active');

            // Populate agent view
            document.getElementById('agentScreen').textContent = currentScreen;
            document.getElementById('agentCartValue').textContent = `‚Çπ${cartValue.toLocaleString()}`;
            document.getElementById('agentGuestCount').textContent = guestCount;
            document.getElementById('agentEventType').textContent = document.getElementById('eventType').value || 'Not selected';
            document.getElementById('agentPackage').textContent = selectedPackage || 'Not selected';
            document.getElementById('agentUserType').textContent = document.getElementById('isFirstTimeUser').checked ? 'First-Time User' : 'Returning Customer';

            if (lastFrictionResult) {
                document.getElementById('agentFrictionScore').textContent = `${lastFrictionResult.friction_score}/100 (${lastFrictionResult.friction_score >= 50 ? 'HIGH' : 'NORMAL'})`;
            }
            if (lastRoutingResult) {
                document.getElementById('agentPriority').textContent = lastRoutingResult.priority;
            }
        }

        // Close agent modal
        function closeAgentModal() {
            document.getElementById('agentModal').classList.remove('active');
        }

        // Close modal on outside click
        document.getElementById('agentModal').addEventListener('click', function (e) {
            if (e.target === this) closeAgentModal();
        });

        // ========== FRESHCHAT INTEGRATION ==========

        // Track if chat is allowed
        let chatAllowed = false;

        // Open Freshchat when allowed
        async function openFreshchat() {
            if (window.fcWidget && chatAllowed) {
                // ========== CREATE INCIDENCE FIRST ==========
                let incidenceId = null;
                try {
                    const incidenceData = {
                        user_id: "syed_ashfaque",
                        stage: "PRE_ORDER",
                        channel: "IN_APP_CHAT",
                        trigger: "USER_INITIATED",
                        app_screen: currentScreen,
                        cart_value: cartValue,
                        guest_count: guestCount,
                        event_type: document.getElementById('eventType').value || "CASUAL",
                        friction_score: lastFrictionResult ? lastFrictionResult.friction_score : 0
                    };

                    const response = await fetch(`${API_BASE}/api/v1/incidences/`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(incidenceData)
                    });

                    if (response.ok) {
                        const incidence = await response.json();
                        incidenceId = incidence.id;
                        console.log('‚úÖ Incidence created:', incidenceId);
                    } else {
                        console.error('Failed to create incidence:', await response.text());
                    }
                } catch (error) {
                    console.error('Error creating incidence:', error);
                }
                // =============================================

                // Set user properties for agent context - INCLUDING incidence_id
                // IMPORTANT: externalId is required for API to find user later
                window.fcWidget.user.setProperties({
                    firstName: "Rahul",
                    lastName: "Sharma",
                    email: "syed.ashfaque@craftmyplate.com",  // Required for user identification
                    externalId: "syed_ashfaque",  // CRITICAL: Links widget user to API user
                    // CRITICAL: Pass incidence_id for webhook linkage
                    incidence_id: incidenceId,
                    cf_incidence_id: incidenceId,  // Backup with cf_ prefix
                    // Custom properties for agent dashboard
                    cf_cart_value: `‚Çπ${cartValue.toLocaleString()}`,
                    cf_guest_count: guestCount,
                    cf_event_type: document.getElementById('eventType').value || 'Not selected',
                    cf_package: selectedPackage || 'Not selected',
                    cf_friction_score: lastFrictionResult ? lastFrictionResult.friction_score : 0,
                    cf_current_screen: currentScreen,
                    cf_user_type: document.getElementById('isFirstTimeUser').checked ? 'First-Time User' : 'Returning Customer',
                    cf_priority: lastRoutingResult ? lastRoutingResult.priority : 'NORMAL'
                });

                // Open the chat widget
                window.fcWidget.open();
            } else if (!chatAllowed) {
                alert('Chat support is not available for this order value. Please check the routing rules.');
            } else {
                alert('Freshchat widget is loading... Please try again in a moment.');
            }
        }

        // Update displayResults to show "Open Chat" button when chat is allowed
        const originalDisplayResults = displayResults;
        displayResults = function (routing, friction) {
            originalDisplayResults(routing, friction);

            // Check if chat/call is allowed
            chatAllowed = routing.allowed_channels.includes('CHAT');
            const callAllowed = routing.allowed_channels.includes('CALL');

            // Add "Open Live Chat" button if chat is allowed
            const resultsPanel = document.getElementById('resultsPanel');
            let chatButton = document.getElementById('openChatBtn');
            let callButton = document.getElementById('requestCallBtn');

            // Create Chat Button if not exists
            if (!chatButton) {
                chatButton = document.createElement('button');
                chatButton.id = 'openChatBtn';
                chatButton.className = 'help-button';
                chatButton.style.background = 'linear-gradient(135deg, #27ae60, #2ecc71)';
                chatButton.style.marginTop = '15px';
                chatButton.innerHTML = 'üí¨ Open Live Chat with Agent';
                chatButton.onclick = openFreshchat;
                resultsPanel.appendChild(chatButton);
            }

            // Create Call Button if not exists
            if (!callButton) {
                callButton = document.createElement('button');
                callButton.id = 'requestCallBtn';
                callButton.className = 'help-button';
                callButton.style.background = 'linear-gradient(135deg, #9b59b6, #8e44ad)';
                callButton.style.marginTop = '10px';
                callButton.innerHTML = 'üìû Request a Call Back';
                callButton.onclick = requestCall;
                resultsPanel.appendChild(callButton);
            }

            // Show/hide based on routing
            chatButton.style.display = chatAllowed ? 'flex' : 'none';
            callButton.style.display = callAllowed ? 'flex' : 'none';
        };

        // Request a call back
        async function requestCall() {
            try {
                const incidenceData = {
                    user_id: "syed_ashfaque",
                    stage: "PRE_ORDER",
                    channel: "CALL",
                    trigger: "USER_INITIATED",
                    app_screen: currentScreen,
                    cart_value: cartValue,
                    guest_count: guestCount,
                    event_type: document.getElementById('eventType').value || "CASUAL",
                    friction_score: lastFrictionResult ? lastFrictionResult.friction_score : 0,
                    user_phone: "1234567892"  // Mock phone number
                };

                const response = await fetch(`${API_BASE}/api/v1/incidences/`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(incidenceData)
                });

                if (response.ok) {
                    const incidence = await response.json();
                    console.log('‚úÖ Call request incidence created:', incidence.id);

                    // Show confirmation modal
                    alert('üìû Call Request Submitted!\n\nOur team will call you within 5 minutes.\n\nIncidence ID: ' + incidence.id.substring(0, 8) + '...');
                } else {
                    alert('Failed to request call. Please try again.');
                }
            } catch (error) {
                console.error('Error requesting call:', error);
                alert('Failed to request call. Please try again.');
            }
        }

        // ========== CALL REQUEST FROM FRESHCHAT BOT ==========
        // This function can be triggered by Freshchat Bot using "Trigger JS Function" action
        // Configure in Freshchat Dashboard: Bot Builder ‚Üí Create Flow ‚Üí Add Button ‚Üí Trigger JS Function ‚Üí "requestCallFromChat"

        window.requestCallFromChat = async function () {
            // Prompt for phone number
            const phone = prompt('üìû Please enter your phone number to receive a call:');

            if (!phone || phone.trim().length < 10) {
                alert('Please enter a valid phone number.');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/v1/call/request`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_id: 'rahul_sharma',
                        phone: phone.trim(),
                        cart_value: cartValue,
                        event_type: document.getElementById('eventType').value || 'CASUAL',
                        friction_score: lastFrictionResult ? lastFrictionResult.friction_score : 0,
                        app_screen: currentScreen
                    })
                });

                if (response.ok) {
                    const result = await response.json();
                    console.log('‚úÖ Call request submitted:', result);

                    // Show confirmation in chat if Freshchat widget available
                    if (window.fcWidget) {
                        window.fcWidget.track('call_requested', {
                            phone: phone,
                            incidence_id: result.incidence_id
                        });
                    }

                    alert(`üìû ${result.message}\n\nYou will receive a call at: ${phone}`);
                } else {
                    alert('‚ùå Failed to submit call request. Please try again.');
                }
            } catch (error) {
                console.error('Call request error:', error);
                alert('‚ùå Failed to submit call request. Please try again.');
            }
        };

        console.log('‚úÖ requestCallFromChat function registered for Freshchat bot trigger');
    </script>

    <!-- ========== CUSTOM SUPPORT WIDGET ========== -->
    <style>
        /* Hide default Freshchat launcher button only (not the chat window) */
        .fc-widget-small,
        #fc_frame.fc-widget-small {
            display: none !important;
        }

        /* Show the chat frame when expanded */
        #fc_frame.fc-open {
            display: block !important;
        }

        /* Custom Support Widget Container */
        .support-widget {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 999999;
            font-family: 'Inter', sans-serif;
        }

        /* Main Toggle Button */
        .support-toggle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: none;
            color: white;
            font-size: 26px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .support-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.7);
        }

        .support-toggle.active {
            transform: rotate(45deg);
            background: linear-gradient(135deg, #e74c3c, #c0392b);
        }

        /* Expanded Menu */
        .support-menu {
            position: absolute;
            bottom: 75px;
            right: 0;
            background: rgba(26, 26, 46, 0.98);
            border-radius: 16px;
            padding: 16px;
            min-width: 220px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px) scale(0.95);
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .support-menu.active {
            opacity: 1;
            visibility: visible;
            transform: translateY(0) scale(1);
        }

        .support-menu-header {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .support-menu-header span {
            color: #f39c12;
        }

        /* Menu Buttons */
        .support-btn {
            width: 100%;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            margin-bottom: 8px;
        }

        .support-btn:last-child {
            margin-bottom: 0;
        }

        .support-btn-chat {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .support-btn-chat:hover {
            background: linear-gradient(135deg, #219a52, #27ae60);
            transform: translateX(5px);
        }

        .support-btn-call {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
        }

        .support-btn-call:hover {
            background: linear-gradient(135deg, #8e44ad, #7d3c98);
            transform: translateX(5px);
        }

        .support-btn-icon {
            font-size: 20px;
        }

        .support-btn-text {
            flex: 1;
            text-align: left;
        }

        .support-btn-arrow {
            opacity: 0.7;
        }

        /* No Support Message */
        .support-no-access {
            color: rgba(255, 255, 255, 0.6);
            font-size: 13px;
            text-align: center;
            padding: 10px;
        }

        /* Pulse Animation for High Priority */
        @keyframes pulse {
            0% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            }

            50% {
                box-shadow: 0 4px 30px rgba(102, 126, 234, 0.8), 0 0 0 10px rgba(102, 126, 234, 0.1);
            }

            100% {
                box-shadow: 0 4px 20px rgba(102, 126, 234, 0.5);
            }
        }

        .support-toggle.high-priority {
            animation: pulse 2s infinite;
        }

        /* Hidden state */
        .support-widget.hidden {
            display: none !important;
        }
    </style>

    <div class="support-widget hidden" id="supportWidget">
        <!-- Expandable Menu -->
        <div class="support-menu" id="supportMenu">
            <div class="support-menu-header">
                üéß Need Help? <span id="supportPriority"></span>
            </div>

            <!-- Chat Button -->
            <button class="support-btn support-btn-chat" id="chatBtn" onclick="openSupportChat()">
                <span class="support-btn-icon">üí¨</span>
                <span class="support-btn-text">Chat with us</span>
                <span class="support-btn-arrow">‚Üí</span>
            </button>

            <!-- Call Button -->
            <button class="support-btn support-btn-call" id="callBtn" onclick="callSupport()">
                <span class="support-btn-icon">üìû</span>
                <span class="support-btn-text">Call us now</span>
                <span class="support-btn-arrow">‚Üí</span>
            </button>

            <!-- No Support Message (shown when no channels available) -->
            <div class="support-no-access" id="noSupportMsg" style="display: none;">
                Self-service only for this order value.<br>
                Add more to cart to unlock support.
            </div>
        </div>

        <!-- Main Toggle Button -->
        <button class="support-toggle" id="supportToggle" onclick="toggleSupportMenu()">
            üéß
        </button>
    </div>

    <script>
        // ========== CUSTOM SUPPORT WIDGET LOGIC ==========
        const SUPPORT_PHONE = 'tel:+911234567891';

        let widgetChatAllowed = false;
        let widgetCallAllowed = false;

        // Toggle support menu
        function toggleSupportMenu() {
            const menu = document.getElementById('supportMenu');
            const toggle = document.getElementById('supportToggle');

            menu.classList.toggle('active');
            toggle.classList.toggle('active');

            // Change icon when open
            toggle.innerHTML = toggle.classList.contains('active') ? '‚úï' : 'üéß';
        }

        // Open Freshchat for support
        async function openSupportChat() {
            if (!widgetChatAllowed) {
                alert('Chat support is not available for this order value.');
                return;
            }

            // Close menu first
            document.getElementById('supportMenu').classList.remove('active');
            document.getElementById('supportToggle').classList.remove('active');
            document.getElementById('supportToggle').innerHTML = 'üéß';

            // Show the Freshchat frame before opening
            const fcFrame = document.getElementById('fc_frame');
            if (fcFrame) {
                fcFrame.style.display = 'block';
            }

            // Create incidence and open Freshchat
            await openFreshchat();
        }

        // Call support number directly
        function callSupport() {
            if (!widgetCallAllowed) {
                alert('Call support is not available for this order value.');
                return;
            }

            // Close menu
            document.getElementById('supportMenu').classList.remove('active');
            document.getElementById('supportToggle').classList.remove('active');
            document.getElementById('supportToggle').innerHTML = 'üéß';

            // Open Freshchat Widget (User can select 'Phone' tab inside if enabled)
            if (window.fcWidget) {
                window.fcWidget.open();
            } else {
                alert("Support widget is loading...");
            }
        }

        // Update widget visibility based on routing
        function updateSupportWidget(routing) {
            const widget = document.getElementById('supportWidget');
            const chatBtn = document.getElementById('chatBtn');
            const callBtn = document.getElementById('callBtn');
            const noSupportMsg = document.getElementById('noSupportMsg');
            const toggle = document.getElementById('supportToggle');
            const priorityLabel = document.getElementById('supportPriority');

            widgetChatAllowed = routing.allowed_channels.includes('CHAT');
            widgetCallAllowed = routing.allowed_channels.includes('CALL');

            // Show/hide widget based on if any channel is available
            if (widgetChatAllowed || widgetCallAllowed) {
                widget.classList.remove('hidden');
                noSupportMsg.style.display = 'none';

                // Show/hide individual buttons
                chatBtn.style.display = widgetChatAllowed ? 'flex' : 'none';
                callBtn.style.display = widgetCallAllowed ? 'flex' : 'none';

                // Add pulse for high priority
                if (routing.priority === 'HIGH') {
                    toggle.classList.add('high-priority');
                    priorityLabel.textContent = 'üî• Premium';
                } else {
                    toggle.classList.remove('high-priority');
                    priorityLabel.textContent = '';
                }
            } else {
                // No channels available - hide widget entirely
                widget.classList.add('hidden');
            }
        }

        // Hook into the existing displayResults to update widget
        const originalDisplayResultsForWidget = displayResults;
        displayResults = function (routing, friction) {
            originalDisplayResultsForWidget(routing, friction);
            updateSupportWidget(routing);
        };

        // Close menu when clicking outside
        document.addEventListener('click', function (e) {
            const widget = document.getElementById('supportWidget');
            const menu = document.getElementById('supportMenu');
            const toggle = document.getElementById('supportToggle');

            if (!widget.contains(e.target) && menu.classList.contains('active')) {
                menu.classList.remove('active');
                toggle.classList.remove('active');
                toggle.innerHTML = 'üéß';
            }
        });

        console.log('‚úÖ Custom Support Widget initialized');
    </script>

    <!-- Freshchat Widget - Hidden launcher, we use custom widget -->
    <script src='//in.fw-cdn.com/32682765/1503844.js' chat='true'>
    </script>

    <script>
        // Freshchat widget event handlers
        window.addEventListener('load', function () {
            // Wait for Freshchat to initialize
            setTimeout(function () {
                if (window.fcWidget) {
                    // Listen for widget close to rehide the frame
                    window.fcWidget.on('widget:closed', function () {
                        const fcFrame = document.getElementById('fc_frame');
                        if (fcFrame) {
                            fcFrame.style.display = 'none';
                        }
                    });
                    console.log('‚úÖ Freshchat widget events registered');
                }
            }, 2000);
        });
    </script>
</body>

</html>